var RtcRoom = (function () {
    function RtcRoom(stream) {
        this._roomId = "74c61bdf-a7bd-4e61-b129-a52e55fab443";
        this._currentId = this._roomId;
        this._peerMap = {};
        this._eventMap = {};
        this._socket = io.connect("http://192.168.1.160:1239/");
        this._localStream = stream;
        var self = this;
        this._socket.on('msg', function (data) {
            self.handleMessages(data);
        });
        this._socket.on('peer.connected', function (data) {
            self.makeOfferFor(data.id);
        });
        this._socket.on('peer.disconnected', function (data) {
            console.log("peer aborted");
        });
    }
    RtcRoom.prototype.getPeerConnection = function (id) {
        if (this._peerMap[id]) {
            return this._peerMap[id];
        }
        var pc = new RTCPeerConnection(RtcRoom.ICE_CONFIG);
        this._peerMap[id] = pc;
        var self = this;
        pc.addStream(this._localStream);
        pc.onicecandidate = function (evnt) {
            console.log("ICE candidate recieved... broadcasting request");
            self._socket.emit('msg', { by: self._currentId, to: id, ice: evnt.candidate, type: 'ice' });
        };
        pc.onaddstream = function (event) {
            console.log("Got new stream.. inform UI?");
            self.trigger('newstream', event);
        };
        pc.onremovestream = function (event) {
            console.log("Stream lost");
        };
        return pc;
    };
    RtcRoom.prototype.makeOfferFor = function (id) {
        var _this = this;
        var peer = this.getPeerConnection(id);
        peer.createOffer(function (description) {
            peer.setLocalDescription(description);
            console.log("Creating offer for Peer... ID: " + id);
            _this._socket.emit('msg', { by: _this._currentId, to: id, sdp: description, type: 'sdp-offer' });
        });
    };
    RtcRoom.prototype.handleMessages = function (messageData) {
        var peer = this.getPeerConnection(messageData.by);
        var self = this;
        switch (messageData.type) {
            case 'sdp-offer':
                peer.setRemoteDescription(new RTCSessionDescription(messageData.sdp), function () {
                    console.log('Setting remote description by offer');
                    peer.createAnswer(function (sdp) {
                        peer.setLocalDescription(sdp);
                        self._socket.emit('msg', { by: self._currentId, to: messageData.by, sdp: sdp, type: 'sdp-answer' });
                    });
                });
                break;
            case 'sdp-answer':
                peer.setRemoteDescription(new RTCSessionDescription(messageData.sdp), function () {
                    console.log('Setting remote description by answer');
                }, function (e) {
                    console.error(e);
                });
                break;
            case 'ice':
                if (messageData.ice) {
                    console.log('Adding ice candidates... OK!');
                    console.log(messageData);
                    var cand = new RTCIceCandidate(messageData.ice);
                    peer.addIceCandidate(cand, function () { }, function () { });
                }
                break;
        }
    };
    RtcRoom.prototype.createRoom = function () {
        var _this = this;
        this._socket.emit('init', null, function (room, userId) {
            _this._currentId = userId;
            _this._roomId = room;
        });
    };
    RtcRoom.prototype.join = function () {
        var _this = this;
        this._socket.emit('init', { room: this._roomId }, function (room, userId) {
            _this._currentId = userId;
        });
    };
    RtcRoom.prototype.on = function (eventType, listener) {
        if (!this._eventMap[eventType])
            this._eventMap[eventType] = [];
        this._eventMap[eventType].push(listener);
    };
    RtcRoom.prototype.trigger = function (eventType, data) {
        this._eventMap[eventType].forEach(function (listener) {
            listener(data);
        });
    };
    RtcRoom.prototype.sendMessage = function (s) {
    };
    RtcRoom.ICE_CONFIG = {
        'iceServers': [{
                'url': 'stun:stun.l.google.com:19302'
            }]
    };
    return RtcRoom;
})();
exports.RtcRoom = RtcRoom;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZpY2VzL1J0Y1Jvb20udHMiXSwibmFtZXMiOlsiUnRjUm9vbSIsIlJ0Y1Jvb20uY29uc3RydWN0b3IiLCJSdGNSb29tLmdldFBlZXJDb25uZWN0aW9uIiwiUnRjUm9vbS5tYWtlT2ZmZXJGb3IiLCJSdGNSb29tLmhhbmRsZU1lc3NhZ2VzIiwiUnRjUm9vbS5jcmVhdGVSb29tIiwiUnRjUm9vbS5qb2luIiwiUnRjUm9vbS5vbiIsIlJ0Y1Jvb20udHJpZ2dlciIsIlJ0Y1Jvb20uc2VuZE1lc3NhZ2UiXSwibWFwcGluZ3MiOiJBQU1BO0lBaUJDQSxpQkFBWUEsTUFBbUJBO1FBVHZCQyxZQUFPQSxHQUFXQSxzQ0FBc0NBLENBQUNBO1FBQ3pEQSxlQUFVQSxHQUFXQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQTtRQUdsQ0EsYUFBUUEsR0FBV0EsRUFBRUEsQ0FBQ0E7UUFxSHRCQSxjQUFTQSxHQUFXQSxFQUFFQSxDQUFDQTtRQS9HOUJBLElBQUlBLENBQUNBLE9BQU9BLEdBQUdBLEVBQUVBLENBQUNBLE9BQU9BLENBQUNBLDRCQUE0QkEsQ0FBQ0EsQ0FBQ0E7UUFDeERBLElBQUlBLENBQUNBLFlBQVlBLEdBQUdBLE1BQU1BLENBQUNBO1FBRTNCQSxJQUFJQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUdoQkEsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsS0FBS0EsRUFBRUEsVUFBQ0EsSUFBSUE7WUFDM0JBLElBQUlBLENBQUNBLGNBQWNBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1FBQzNCQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUVIQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxFQUFFQSxDQUFDQSxnQkFBZ0JBLEVBQUVBLFVBQUNBLElBQUlBO1lBQ3RDQSxJQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQTtRQUM1QkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFSEEsSUFBSUEsQ0FBQ0Es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Q0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0E7SUFDMUNBLENBQUNBO0lBRU9QLHlCQUFPQSxHQUFmQSxVQUFnQkEsU0FBa0JBLEVBQUVBLElBQVVBO1FBQzdDUSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQSxPQUFPQSxDQUFDQSxVQUFBQSxRQUFRQTtZQUN6Q0EsUUFBUUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDaEJBLENBQUNBLENBQUNBLENBQUNBO0lBQ0pBLENBQUNBO0lBRURSLDZCQUFXQSxHQUFYQSxVQUFZQSxDQUFTQTtJQUVyQlMsQ0FBQ0E7SUFuSmNULGtCQUFVQSxHQUFXQTtRQUNuQ0EsWUFBWUEsRUFBRUEsQ0FBQ0E7Z0JBQ2RBLEtBQUtBLEVBQUVBLDhCQUE4QkE7YUFDckNBLENBQUNBO0tBQ0ZBLENBQUFBO0lBbUpGQSxjQUFDQTtBQUFEQSxDQXpKQSxBQXlKQ0EsSUFBQTtBQXpKWSxlQUFPLFVBeUpuQixDQUFBIiwiZmlsZSI6InNlcnZpY2VzL1J0Y1Jvb20uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1ZpZGVvU3RyZWFtfSBmcm9tICcuL1ZpZGVvU3RyZWFtJztcblxuLyoqXG4gKiBQcm92aWRlcyBhbiBlbmNhcHN1bGF0ZWQgdmlldyBvZiBhIHJvb20gaW4gV2ViUlRDLlxuICogQWxsb3dzIHVzZXJzIHRvIGdldCB1cCBhbmQgcnVubmluZyB3aXRoIGEgcm9vbS5cbiAqL1xuZXhwb3J0IGNsYXNzIFJ0Y1Jvb20ge1xuXG5cdHByaXZhdGUgc3RhdGljIElDRV9DT05GSUc6IE9iamVjdCA9IHtcblx0XHQnaWNlU2VydmVycyc6IFt7XG5cdFx0XHQndXJsJzogJ3N0dW46c3R1bi5sLmdvb2dsZS5jb206MTkzMDInXG5cdFx0fV1cblx0fVxuXG5cdHByaXZhdGUgX3Jvb21JZDogc3RyaW5nID0gXCI3NGM2MWJkZi1hN2JkLTRlNjEtYjEyOS1hNTJlNTVmYWI0NDNcIjtcblx0cHJpdmF0ZSBfY3VycmVudElkOiBzdHJpbmcgPSB0aGlzLl9yb29tSWQ7XG5cblx0cHJpdmF0ZSBfc29ja2V0OiBTb2NrZXQ7XG5cdHByaXZhdGUgX3BlZXJNYXA6IE9iamVjdCA9IHt9O1xuXG5cdHByaXZhdGUgX2xvY2FsU3RyZWFtOiBNZWRpYVN0cmVhbTtcblxuXG5cdGNvbnN0cnVjdG9yKHN0cmVhbTogTWVkaWFTdHJlYW0pIHtcblx0XHR0aGlzLl9zb2NrZXQgPSBpby5jb25uZWN0KFwiaHR0cDovLzE5Mi4xNjguMS4xNjA6MTIzOS9cIik7XG5cdFx0dGhpcy5fbG9jYWxTdHJlYW0gPSBzdHJlYW07XG5cblx0XHR2YXIgc2VsZiA9IHRoaXM7XG5cdFx0XG5cdFx0Ly8gUmVnaXN0ZXIgaGFuZGxlcnMgYXMgbmVlZGVkXG5cdFx0dGhpcy5fc29ja2V0Lm9uKCdtc2cnLCAoZGF0YSkgPT4ge1xuXHRcdFx0c2VsZi5oYW5kbGVNZXNzYWdlcyhkYXRhKTtcblx0XHR9KTtcblxuXHRcdHRoaXMuX3NvY2tldC5vbigncGVlci5jb25uZWN0ZWQnLCAoZGF0YSkgPT4ge1xuXHRcdFx0c2VsZi5tYWtlT2ZmZXJGb3IoZGF0YS5pZCk7XG5cdFx0fSk7XG5cblx0XHR0aGlzLl9zb2NrZXQub24oJ3BlZXIuZGlzY29ubmVjdGVkJywgKGRhdGEpID0+IHtcblx0XHRcdC8vIFJlbW92ZSB0aGVtIHByb3Blcmx5IGZyb20gdGhlIFVJPj9cblx0XHRcdGNvbnNvbGUubG9nKFwicGVlciBhYm9ydGVkXCIpO1xuXHRcdH0pXG5cblx0fVxuXG5cdHByaXZhdGUgZ2V0UGVlckNvbm5lY3Rpb24oaWQ6IHN0cmluZyk6IFJUQ1BlZXJDb25uZWN0aW9uIHtcblx0XHQgICAgICBpZiAodGhpcy5fcGVlck1hcFtpZF0pIHtcblx0XHRcdHJldHVybiB0aGlzLl9wZWVyTWFwW2lkXTtcblx0XHR9XG5cblx0XHR2YXIgcGM6IFJUQ1BlZXJDb25uZWN0aW9uID0gbmV3IFJUQ1BlZXJDb25uZWN0aW9uKFJ0Y1Jvb20uSUNFX0NPTkZJRyk7XG5cblx0XHR0aGlzLl9wZWVyTWFwW2lkXSA9IHBjO1xuXG5cdFx0dmFyIHNlbGYgPSB0aGlzO1xuXHRcdHBjLmFkZFN0cmVhbSh0aGlzLl9sb2NhbFN0cmVhbSk7XG5cdFx0XG5cdFx0cGMub25pY2VjYW5kaWRhdGUgPSBmdW5jdGlvbihldm50KSB7XG5cdFx0XHRjb25zb2xlLmxvZyhcIklDRSBjYW5kaWRhdGUgcmVjaWV2ZWQuLi4gYnJvYWRjYXN0aW5nIHJlcXVlc3RcIik7XG5cdFx0XHRzZWxmLl9zb2NrZXQuZW1pdCgnbXNnJywgeyBieTogc2VsZi5fY3VycmVudElkLCB0bzogaWQsIGljZTogZXZudC5jYW5kaWRhdGUsIHR5cGU6ICdpY2UnIH0pO1xuXHRcdH07XG5cdFx0cGMub25hZGRzdHJlYW0gPSBmdW5jdGlvbihldmVudCkge1xuXHRcdFx0Y29uc29sZS5sb2coXCJHb3QgbmV3IHN0cmVhbS4uIGluZm9ybSBVST9cIik7XG5cdFx0XHRzZWxmLnRyaWdnZXIoJ25ld3N0cmVhbScsIGV2ZW50KTtcblx0XHR9O1xuXHRcdFxuXHRcdHBjLm9ucmVtb3Zlc3RyZWFtID0gZnVuY3Rpb24oZXZlbnQpIHtcblx0XHRcdGNvbnNvbGUubG9nKFwiU3RyZWFtIGxvc3RcIik7XG5cdFx0fVxuXHRcdFxuXHRcdHJldHVybiBwYztcblx0fVxuXG5cdHByaXZhdGUgbWFrZU9mZmVyRm9yKGlkOiBzdHJpbmcpIHtcblx0XHR2YXIgcGVlcjogUlRDUGVlckNvbm5lY3Rpb24gPSB0aGlzLmdldFBlZXJDb25uZWN0aW9uKGlkKTtcblxuXHRcdHBlZXIuY3JlYXRlT2ZmZXIoKGRlc2NyaXB0aW9uOiBSVENTZXNzaW9uRGVzY3JpcHRpb24pID0+IHtcblx0XHRcdHBlZXIuc2V0TG9jYWxEZXNjcmlwdGlvbihkZXNjcmlwdGlvbik7XG5cdFx0XHRjb25zb2xlLmxvZyhcIkNyZWF0aW5nIG9mZmVyIGZvciBQZWVyLi4uIElEOiBcIiArIGlkKTtcblx0XHRcdHRoaXMuX3NvY2tldC5lbWl0KCdtc2cnLCB7IGJ5OiB0aGlzLl9jdXJyZW50SWQsIHRvOiBpZCwgc2RwOiBkZXNjcmlwdGlvbiwgdHlwZTogJ3NkcC1vZmZlcicgfSk7XG5cdFx0fSlcblx0fVxuXG5cdHByaXZhdGUgaGFuZGxlTWVzc2FnZXMobWVzc2FnZURhdGE6IGFueSkge1xuXHRcdHZhciBwZWVyOiBSVENQZWVyQ29ubmVjdGlvbiA9IHRoaXMuZ2V0UGVlckNvbm5lY3Rpb24obWVzc2FnZURhdGEuYnkpO1xuXHRcdHZhciBzZWxmID0gdGhpcztcblxuXHRcdHN3aXRjaCAobWVzc2FnZURhdGEudHlwZSkge1xuXHRcdFx0Y2FzZSAnc2RwLW9mZmVyJzpcblx0XHRcdFx0cGVlci5zZXRSZW1vdGVEZXNjcmlwdGlvbihuZXcgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKG1lc3NhZ2VEYXRhLnNkcCksIGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRcdGNvbnNvbGUubG9nKCdTZXR0aW5nIHJlbW90ZSBkZXNjcmlwdGlvbiBieSBvZmZlcicpO1xuXHRcdFx0XHRcdHBlZXIuY3JlYXRlQW5zd2VyKGZ1bmN0aW9uKHNkcCkge1xuXHRcdFx0XHRcdFx0cGVlci5zZXRMb2NhbERlc2NyaXB0aW9uKHNkcCk7XG5cdFx0XHRcdFx0XHRzZWxmLl9zb2NrZXQuZW1pdCgnbXNnJywgeyBieTogc2VsZi5fY3VycmVudElkLCB0bzogbWVzc2FnZURhdGEuYnksIHNkcDogc2RwLCB0eXBlOiAnc2RwLWFuc3dlcicgfSk7XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRicmVhaztcblxuXHRcdFx0Y2FzZSAnc2RwLWFuc3dlcic6XG5cdFx0XHRcdHBlZXIuc2V0UmVtb3RlRGVzY3JpcHRpb24obmV3IFJUQ1Nlc3Npb25EZXNjcmlwdGlvbihtZXNzYWdlRGF0YS5zZHApLCBmdW5jdGlvbigpIHtcblx0XHRcdFx0XHRjb25zb2xlLmxvZygnU2V0dGluZyByZW1vdGUgZGVzY3JpcHRpb24gYnkgYW5zd2VyJyk7XG5cdFx0XHRcdH0sIGZ1bmN0aW9uKGUpIHtcblx0XHRcdFx0XHRjb25zb2xlLmVycm9yKGUpO1xuXHRcdFx0XHR9KTtcblx0XHRcdFx0YnJlYWs7XG5cblx0XHRcdGNhc2UgJ2ljZSc6XG5cdFx0XHRcdGlmIChtZXNzYWdlRGF0YS5pY2UpIHtcblx0XHRcdFx0XHRjb25zb2xlLmxvZygnQWRkaW5nIGljZSBjYW5kaWRhdGVzLi4uIE9LIScpO1xuXHRcdFx0XHRcdGNvbnNvbGUubG9nKG1lc3NhZ2VEYXRhKTtcblx0XHRcdFx0XHR2YXIgY2FuZDogUlRDSWNlQ2FuZGlkYXRlID0gbmV3IFJUQ0ljZUNhbmRpZGF0ZShtZXNzYWdlRGF0YS5pY2UpO1xuXHRcdFx0XHRcdHBlZXIuYWRkSWNlQ2FuZGlkYXRlKGNhbmQsICgpID0+IHsgfSwgKCkgPT4geyB9KTtcblx0XHRcdFx0fVxuXHRcdFx0XHRicmVhaztcblx0XHR9XG5cdH1cblx0XG5cdFxuXHRcblx0LyoqXG5cdCAqIEF0dGVtcHRzIHRvIGNyZWF0ZSB0aGUgY3VycmVudCByb29tLlxuXHQgKi9cblx0Y3JlYXRlUm9vbSgpOiB2b2lkIHtcblx0XHR0aGlzLl9zb2NrZXQuZW1pdCgnaW5pdCcsIG51bGwsIChyb29tLCB1c2VySWQpID0+IHtcblx0XHRcdHRoaXMuX2N1cnJlbnRJZCA9IHVzZXJJZDtcblx0XHRcdHRoaXMuX3Jvb21JZCA9IHJvb207XG5cdFx0fSk7XG5cdH1cblxuXHRqb2luKCk6IHZvaWQge1xuXHRcdHRoaXMuX3NvY2tldC5lbWl0KCdpbml0JywgeyByb29tOiB0aGlzLl9yb29tSWQgfSwgKHJvb20sIHVzZXJJZCkgPT4ge1xuXHRcdFx0dGhpcy5fY3VycmVudElkID0gdXNlcklkO1xuXHRcdH0pO1xuXHR9XG5cblx0cHJpdmF0ZSBfZXZlbnRNYXA6IE9iamVjdCA9IHt9O1xuXG5cdC8qKlxuXHQgKiBBbGxvd3MgbGlzdGVuaW5nIGZvciBhIHBhcnRpY3VsYXIgc2V0IG9mIGxpc3RlbmVycyBmb3IgYSBjZXJ0YWluIGV2ZW50XG5cdCAqL1xuXHRvbihldmVudFR5cGU6IHN0cmluZywgbGlzdGVuZXIgOiBGdW5jdGlvbikge1xuXHRcdGlmICghdGhpcy5fZXZlbnRNYXBbZXZlbnRUeXBlXSlcblx0XHRcdHRoaXMuX2V2ZW50TWFwW2V2ZW50VHlwZV0gPSBbXTtcblx0XHRcblx0XHR0aGlzLl9ldmVudE1hcFtldmVudFR5cGVdLnB1c2gobGlzdGVuZXIpO1xuXHR9XG5cdFxuXHRwcml2YXRlIHRyaWdnZXIoZXZlbnRUeXBlIDogc3RyaW5nLCBkYXRhIDogYW55KSB7XG5cdFx0dGhpcy5fZXZlbnRNYXBbZXZlbnRUeXBlXS5mb3JFYWNoKGxpc3RlbmVyID0+IHtcblx0XHRcdGxpc3RlbmVyKGRhdGEpO1xuXHRcdH0pO1xuXHR9XG5cblx0c2VuZE1lc3NhZ2Uoczogc3RyaW5nKSB7XG5cdFx0Ly8gVE9ETzogU2VuZCBhIG1lc3NhZ2UgdG8gdGhlIGVudGlyZSByb29tXG5cdH1cblxuXG5cbn0iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=