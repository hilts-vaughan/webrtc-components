var StreamPeer_1 = require('./StreamPeer');
var StreamRoom = (function () {
    function StreamRoom(localStreams, options, socket, sessionToken) {
        this._peerMap = {};
        this._channelMap = {};
        this._eventMap = {};
        this._localStreams = localStreams;
        this._roomOptions = options;
        this._socket = socket;
        this._sessionToken = sessionToken;
        var self = this;
        alert('reg');
        this._socket.on('msg', function (data) {
            console.log("Handling payload...");
            self.handleMessages(data);
        });
        this._socket.on('peer.connected', function (data) {
            self.makeOfferFor(data.id);
        });
        this._socket.on('peer.disconnected', function (data) {
            self.trigger('peer.removed', { id: data.id });
        });
    }
    StreamRoom.prototype.getPeerConnection = function (id) {
        if (this._peerMap[id]) {
            return this._peerMap[id];
        }
        var pc = new RTCPeerConnection(StreamRoom.ICE_CONFIG);
        var streamPeer = new StreamPeer_1.StreamPeer(pc, id);
        this._peerMap[id] = pc;
        var self = this;
        this._localStreams.forEach(function (stream) {
            pc.addStream(stream);
        });
        pc.onicecandidate = function (evnt) {
            console.log("ICE candidate recieved... broadcasting request");
            console.log(self._sessionToken);
            self._socket.emit('msg', { by: self._sessionToken, to: id, ice: evnt.candidate, type: 'ice' });
        };
        pc.onaddstream = function (event) {
            console.log("Got new stream.. inform UI?");
            self.trigger('newstream', event);
        };
        pc.onremovestream = function (event) {
            console.log("Stream lost");
        };
        var options = {
            ordered: false
        };
        var _channel = pc.createDataChannel("data", options);
        _channel.onopen = function () {
            console.log("Attempted to send data down the pipe.");
        };
        this._channelMap[id] = _channel;
        pc.ondatachannel = function (event) {
            console.log(event);
            console.log("Channel was created");
            event.channel.onmessage = function (payload) {
                self.trigger('data', payload.data);
            };
        };
        return pc;
    };
    StreamRoom.prototype.makeOfferFor = function (id) {
        var _this = this;
        var peer = this.getPeerConnection(id);
        peer.createOffer(function (description) {
            peer.setLocalDescription(description);
            console.log("Creating offer for Peer... ID: " + id);
            _this._socket.emit('msg', { by: _this._sessionToken, to: id, sdp: description, type: 'sdp-offer' });
        }, function () {
            alert('failed');
        });
    };
    StreamRoom.prototype.handleMessages = function (messageData) {
        var peer = this.getPeerConnection(messageData.by);
        var self = this;
        switch (messageData.type) {
            case 'sdp-offer':
                peer.setRemoteDescription(new RTCSessionDescription(messageData.sdp), function () {
                    console.log('Setting remote description by offer');
                    peer.createAnswer(function (sdp) {
                        peer.setLocalDescription(sdp);
                        self._socket.emit('msg', { by: self._sessionToken, to: messageData.by, sdp: sdp, type: 'sdp-answer' });
                    });
                }, function () {
                });
                break;
            case 'sdp-answer':
                peer.setRemoteDescription(new RTCSessionDescription(messageData.sdp), function () {
                    console.log('Setting remote description by answer');
                }, function (e) {
                    console.error(e);
                });
                break;
            case 'ice':
                if (messageData.ice) {
                    console.log('Adding ice candidates... OK!');
                    console.log(messageData);
                    var cand = new RTCIceCandidate(messageData.ice);
                    peer.addIceCandidate(cand, function () { }, function () { });
                }
                break;
        }
    };
    StreamRoom.prototype.sendMessage = function (message) {
        var _this = this;
        Object.keys(this._channelMap).forEach(function (key) {
            var channel = _this._channelMap[key];
            channel.send(message);
        });
    };
    StreamRoom.prototype.on = function (eventType, listener) {
        if (!this._eventMap[eventType])
            this._eventMap[eventType] = [];
        this._eventMap[eventType].push(listener);
    };
    StreamRoom.prototype.trigger = function (eventType, data) {
        console.log("Dispatching event; " + eventType + " to all listeners.");
        this._eventMap[eventType].forEach(function (listener) {
            listener(data);
        });
    };
    Object.defineProperty(StreamRoom.prototype, "roomName", {
        get: function () {
            return this._roomOptions.roomName;
        },
        enumerable: true,
        configurable: true
    });
    StreamRoom.ICE_CONFIG = {
        'iceServers': [{
                'url': 'stun:stun.l.google.com:19302'
            }]
    };
    return StreamRoom;
})();
exports.StreamRoom = StreamRoom;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZpY2VzL3J0Y19hcGkvU3RyZWFtUm9vbS50cyJdLCJuYW1lcyI6WyJTdHJlYW1Sb29tIiwiU3RyZWFtUm9vbS5jb25zdHJ1Y3RvciIsIlN0cmVhbVJvb20uZ2V0UGVlckNvbm5lY3Rpb24iLCJTdHJlYW1Sb29tLm1ha2VPZmZlckZvciIsIlN0cmVhbVJvb20uaGFuZGxlTWVzc2FnZXMiLCJTdHJlYW1Sb29tLnNlbmRNZXNzYWdlIiwiU3RyZWFtUm9vbS5vbiIsIlN0cmVhbVJvb20udHJpZ2dlciIsIlN0cmVhbVJvb20ucm9vbU5hbWUiXSwibWFwcGluZ3MiOiJBQUNBLDJCQUF5QixjQUV6QixDQUFDLENBRnNDO0FBRXZDO0lBZ0JDQSxvQkFBWUEsWUFBZ0NBLEVBQUVBLE9BQW9CQSxFQUFFQSxNQUFjQSxFQUFFQSxZQUFvQkE7UUFIaEdDLGFBQVFBLEdBQVdBLEVBQUVBLENBQUNBO1FBQ3RCQSxnQkFBV0EsR0FBV0EsRUFBRUEsQ0FBQ0E7UUFpSnpCQSxjQUFTQSxHQUFXQSxFQUFFQSxDQUFDQTtRQTlJOUJBLElBQUlBLENBQUNBLGFBQWFBLEdBQUdBLFlBQVlBLENBQUNBO1FBQ2xDQSxJQUFJQSxDQUFDQSxZQUFZQSxHQUFHQSxPQUFPQSxDQUFDQTtRQUM1QkEsSUFBSUEsQ0FBQ0EsT0FBT0EsR0FBR0EsTUFBTUEsQ0FBQ0E7UUFDdEJBLElBQUlBLENBQUNBLGFBQWFBLEdBQUdBLFlBQVlBLENBQUNBO1FBRWxDQSxJQUFJQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUVoQkEsS0FBS0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQUE7UUFFWkEsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsS0FBS0EsRUFBRUEsVUFBQ0EsSUFBSUE7WUFDM0JBLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLHFCQUFxQkEsQ0FBQ0EsQ0FBQ0E7WUFDbkNBLElBQUlBLENBQUNBLGNBQWNBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1FBQzNCQSxDQUFD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Q0FBQ0E7UUFFaENBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLFNBQVNBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBO0lBQzFDQSxDQUFDQTtJQUVPTiw0QkFBT0EsR0FBZkEsVUFBZ0JBLFNBQWlCQSxFQUFFQSxJQUFTQTtRQUMzQ08sT0FBT0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EscUJBQXFCQSxHQUFHQSxTQUFTQSxHQUFHQSxvQkFBb0JBLENBQUNBLENBQUNBO1FBQ3RFQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQSxPQUFPQSxDQUFDQSxVQUFBQSxRQUFRQTtZQUN6Q0EsUUFBUUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDaEJBLENBQUNBLENBQUNBLENBQUNBO0lBQ0pBLENBQUNBO0lBRURQLHNCQUFJQSxnQ0FBUUE7YUFBWkE7WUFDQ1EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsUUFBUUEsQ0FBQ0E7UUFDbkNBLENBQUNBOzs7T0FBQVI7SUFsTGNBLHFCQUFVQSxHQUFXQTtRQUNuQ0EsWUFBWUEsRUFBRUEsQ0FBQ0E7Z0JBQ2RBLEtBQUtBLEVBQUVBLDhCQUE4QkE7YUFDckNBLENBQUNBO0tBQ0ZBLENBQUFBO0lBZ0xGQSxpQkFBQ0E7QUFBREEsQ0F0TEEsQUFzTENBLElBQUE7QUF0TFksa0JBQVUsYUFzTHRCLENBQUEiLCJmaWxlIjoic2VydmljZXMvcnRjX2FwaS9TdHJlYW1Sb29tLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtSb29tT3B0aW9uc30gZnJvbSAnLi9Sb29tT3B0aW9ucydcbmltcG9ydCB7U3RyZWFtUGVlcn0gZnJvbSAnLi9TdHJlYW1QZWVyJ1xuXG5leHBvcnQgY2xhc3MgU3RyZWFtUm9vbSB7XG5cdC8vIFRPRE86IFRoaXMgc2hvdWxkIG5vdCBiZSBoYXJkLWNvZGVkIGlkZWFsbHkuLi4gYnV0IGl0IHdvbid0IGh1cnQgZm9yIG5vd1xuXHRwcml2YXRlIHN0YXRpYyBJQ0VfQ09ORklHOiBPYmplY3QgPSB7XG5cdFx0J2ljZVNlcnZlcnMnOiBbe1xuXHRcdFx0J3VybCc6ICdzdHVuOnN0dW4ubC5nb29nbGUuY29tOjE5MzAyJ1xuXHRcdH1dXG5cdH1cblxuXHRwcml2YXRlIF9yb29tT3B0aW9uczogUm9vbU9wdGlvbnM7XG5cdHByaXZhdGUgX2xvY2FsU3RyZWFtczogQXJyYXk8TWVkaWFTdHJlYW0+O1xuXHRwcml2YXRlIF9zb2NrZXQ6IFNvY2tldDtcblx0cHJpdmF0ZSBfc2Vzc2lvblRva2VuOiBzdHJpbmc7XG5cblx0cHJpdmF0ZSBfcGVlck1hcDogT2JqZWN0ID0ge307XG5cdHByaXZhdGUgX2NoYW5uZWxNYXA6IE9iamVjdCA9IHt9O1xuXG5cdGNvbnN0cnVjdG9yKGxvY2FsU3RyZWFtczogQXJyYXk8TWVkaWFTdHJlYW0+LCBvcHRpb25zOiBSb29tT3B0aW9ucywgc29ja2V0OiBTb2NrZXQsIHNlc3Npb25Ub2tlbjogc3RyaW5nKSB7XG5cdFx0dGhpcy5fbG9jYWxTdHJlYW1zID0gbG9jYWxTdHJlYW1zO1xuXHRcdHRoaXMuX3Jvb21PcHRpb25zID0gb3B0aW9ucztcblx0XHR0aGlzLl9zb2NrZXQgPSBzb2NrZXQ7XG5cdFx0dGhpcy5fc2Vzc2lvblRva2VuID0gc2Vzc2lvblRva2VuO1xuXG5cdFx0dmFyIHNlbGYgPSB0aGlzO1xuXG5cdFx0YWxlcnQoJ3JlZycpXG5cdFx0Ly8gUmVnaXN0ZXIgaGFuZGxlcnMgYXMgbmVlZGVkXG5cdFx0dGhpcy5fc29ja2V0Lm9uKCdtc2cnLCAoZGF0YSkgPT4ge1xuXHRcdFx0Y29uc29sZS5sb2coXCJIYW5kbGluZyBwYXlsb2FkLi4uXCIpO1xuXHRcdFx0c2VsZi5oYW5kbGVNZXNzYWdlcyhkYXRhKTtcblx0XHR9KTtcblxuXHRcdHRoaXMuX3NvY2tldC5vbigncGVlci5jb25uZWN0ZWQnLCAoZGF0YSkgPT4ge1xuXHRcdFx0c2VsZi5tYWtlT2ZmZXJGb3IoZGF0YS5pZCk7XG5cdFx0fSk7XG5cblx0XHR0aGlzLl9zb2NrZXQub24oJ3BlZXIuZGlzY29ubmVjdGVkJywgKGRhdGEpID0+IHtcblx0XHRcdHNlbGYudHJpZ2dlcigncGVlci5yZW1vdmVkJywgeyBpZDogZGF0YS5pZCB9KTtcblx0XHR9KVxuXG5cdH1cblxuXHRwcml2YXRlIGdldFBlZXJDb25uZWN0aW9uKGlkOiBzdHJpbmcpOiBSVENQZWVyQ29ubmVjdGlvbiB7XG5cdFx0aWYgKHRoaXMuX3BlZXJNYXBbaWRdKSB7XG5cdFx0XHRyZXR1cm4gdGhpcy5fcGVlck1hcFtpZF07XG5cdFx0fVxuXG5cdFx0dmFyIHBjOiBSVENQZWVyQ29ubmVjdGlvbiA9IG5ldyBSVENQZWVyQ29ubmVjdGlvbihTdHJlYW1Sb29tLklDRV9DT05GSUcpO1xuXG5cdFx0Ly8gVE9ETzogSW1wbGVtZW50IGEgc3RhY2sgdGhhdCB1c2VzIHRoZSB7U3RyZWFtUGVlcn1cblx0XHQvLyBSaWdodCBub3csIHdlIHJlbHkgb24gdGhlIGJhcmUgbWV0YWwgaW1wbGVtZW50YXRpb24uXG5cblx0XHR2YXIgc3RyZWFtUGVlciA6IFN0cmVhbVBlZXIgPSBuZXcgU3RyZWFtUGVlcihwYywgaWQpO1xuXG5cblx0XHR0aGlzLl9wZWVyTWFwW2lkXSA9IHBjO1xuXG5cdFx0dmFyIHNlbGYgPSB0aGlzO1xuXG5cdFx0Ly8gQWRkIGFsbCBzdHJlYW1zXG5cdFx0dGhpcy5fbG9jYWxTdHJlYW1zLmZvckVhY2goKHN0cmVhbSkgPT4ge1xuXHRcdFx0cGMuYWRkU3RyZWFtKHN0cmVhbSk7XG5cdFx0fSlcblxuXHRcdHBjLm9uaWNlY2FuZGlkYXRlID0gZnVuY3Rpb24oZXZudCkge1xuXHRcdFx0Y29uc29sZS5sb2coXCJJQ0UgY2FuZGlkYXRlIHJlY2lldmVkLi4uIGJyb2FkY2FzdGluZyByZXF1ZXN0XCIpO1xuXHRcdFx0Y29uc29sZS5sb2coc2VsZi5fc2Vzc2lvblRva2VuKTtcblx0XHRcdHNlbGYuX3NvY2tldC5lbWl0KCdtc2cnLCB7IGJ5OiBzZWxmLl9zZXNzaW9uVG9rZW4sIHRvOiBpZCwgaWNlOiBldm50LmNhbmRpZGF0ZSwgdHlwZTogJ2ljZScgfSk7XG5cdFx0fTtcblxuXHRcdHBjLm9uYWRkc3RyZWFtID0gZnVuY3Rpb24oZXZlbnQpIHtcblx0XHRcdGNvbnNvbGUubG9nKFwiR290IG5ldyBzdHJlYW0uLiBpbmZvcm0gVUk/XCIpO1xuXHRcdFx0c2VsZi50cmlnZ2VyKCduZXdzdHJlYW0nLCBldmVudCk7XG5cdFx0fTtcblxuXHRcdHBjLm9ucmVtb3Zlc3RyZWFtID0gZnVuY3Rpb24oZXZlbnQpIHtcblx0XHRcdGNvbnNvbGUubG9nKFwiU3RyZWFtIGxvc3RcIik7XG5cdFx0fVxuXG5cblx0XHQvLyBDYWxsYmFja3MgZm9yIHRleHQgc3RyZWFtc1xuXHRcdHZhciBvcHRpb25zID0ge1xuXHRcdFx0b3JkZXJlZDogZmFsc2Vcblx0XHR9XG5cblx0XHR2YXIgX2NoYW5uZWw6IFJUQ0RhdGFDaGFubmVsID0gcGMuY3JlYXRlRGF0YUNoYW5uZWwoXCJkYXRhXCIsIG9wdGlvbnMpO1xuXG5cdFx0X2NoYW5uZWwub25vcGVuID0gKCkgPT4ge1xuXHRcdFx0Y29uc29sZS5sb2coXCJBdHRlbXB0ZWQgdG8gc2VuZCBkYXRhIGRvd24gdGhlIHBpcGUuXCIpO1xuXHRcdH07XG5cblx0XHQvLyBNYXBzIHRvIHRoZSBjaGFubmVsXG5cdFx0dGhpcy5fY2hhbm5lbE1hcFtpZF0gPSBfY2hhbm5lbDtcblxuXHRcdHBjLm9uZGF0YWNoYW5uZWwgPSAoZXZlbnQ6IGFueSkgPT4ge1xuXHRcdFx0Y29uc29sZS5sb2coZXZlbnQpO1xuXHRcdFx0Y29uc29sZS5sb2coXCJDaGFubmVsIHdhcyBjcmVhdGVkXCIpO1xuXHRcdFx0ZXZlbnQuY2hhbm5lbC5vbm1lc3NhZ2UgPSAocGF5bG9hZCkgPT4ge1xuXHRcdFx0XHRzZWxmLnRyaWdnZXIoJ2RhdGEnLCBwYXlsb2FkLmRhdGEpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiBwYztcblx0fVxuXG5cdHByaXZhdGUgbWFrZU9mZmVyRm9yKGlkOiBzdHJpbmcpIHtcblx0XHR2YXIgcGVlcjogUlRDUGVlckNvbm5lY3Rpb24gPSB0aGlzLmdldFBlZXJDb25uZWN0aW9uKGlkKTtcblxuXHRcdHBlZXIuY3JlYXRlT2ZmZXIoKGRlc2NyaXB0aW9uOiBSVENTZXNzaW9uRGVzY3JpcHRpb24pID0+IHtcblx0XHRcdHBlZXIuc2V0TG9jYWxEZXNjcmlwdGlvbihkZXNjcmlwdGlvbik7XG5cdFx0XHRjb25zb2xlLmxvZyhcIkNyZWF0aW5nIG9mZmVyIGZvciBQZWVyLi4uIElEOiBcIiArIGlkKTtcblx0XHRcdHRoaXMuX3NvY2tldC5lbWl0KCdtc2cnLCB7IGJ5OiB0aGlzLl9zZXNzaW9uVG9rZW4sIHRvOiBpZCwgc2RwOiBkZXNjcmlwdGlvbiwgdHlwZTogJ3NkcC1vZmZlcicgfSk7XG5cdFx0fSwgKCkgPT4ge1xuXHRcdFx0YWxlcnQoJ2ZhaWxlZCcpO1xuXHRcdH0pXG5cdH1cblxuXHRwcml2YXRlIGhhbmRsZU1lc3NhZ2VzKG1lc3NhZ2VEYXRhOiBhbnkpIHtcblx0XHR2YXIgcGVlcjogUlRDUGVlckNvbm5lY3Rpb24gPSB0aGlzLmdldFBlZXJDb25uZWN0aW9uKG1lc3NhZ2VEYXRhLmJ5KTtcblx0XHR2YXIgc2VsZiA9IHRoaXM7XG5cblx0XHRzd2l0Y2ggKG1lc3NhZ2VEYXRhLnR5cGUpIHtcblx0XHRcdGNhc2UgJ3NkcC1vZmZlcic6XG5cdFx0XHRcdHBlZXIuc2V0UmVtb3RlRGVzY3JpcHRpb24obmV3IFJUQ1Nlc3Npb25EZXNjcmlwdGlvbihtZXNzYWdlRGF0YS5zZHApLCBmdW5jdGlvbigpIHtcblx0XHRcdFx0XHRjb25zb2xlLmxvZygnU2V0dGluZyByZW1vdGUgZGVzY3JpcHRpb24gYnkgb2ZmZXInKTtcblx0XHRcdFx0XHRwZWVyLmNyZWF0ZUFuc3dlcihmdW5jdGlvbihzZHApIHtcblx0XHRcdFx0XHRcdHBlZXIuc2V0TG9jYWxEZXNjcmlwdGlvbihzZHApO1xuXHRcdFx0XHRcdFx0c2VsZi5fc29ja2V0LmVtaXQoJ21zZycsIHsgYnk6IHNlbGYuX3Nlc3Npb25Ub2tlbiwgdG86IG1lc3NhZ2VEYXRhLmJ5LCBzZHA6IHNkcCwgdHlwZTogJ3NkcC1hbnN3ZXInIH0pO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9LCBmdW5jdGlvbigpIHtcblxuXHRcdFx0XHR9KTtcblx0XHRcdFx0YnJlYWs7XG5cblx0XHRcdGNhc2UgJ3NkcC1hbnN3ZXInOlxuXHRcdFx0XHRwZWVyLnNldFJlbW90ZURlc2NyaXB0aW9uKG5ldyBSVENTZXNzaW9uRGVzY3JpcHRpb24obWVzc2FnZURhdGEuc2RwKSwgZnVuY3Rpb24oKSB7XG5cdFx0XHRcdFx0Y29uc29sZS5sb2coJ1NldHRpbmcgcmVtb3RlIGRlc2NyaXB0aW9uIGJ5IGFuc3dlcicpO1xuXHRcdFx0XHR9LCBmdW5jdGlvbihlKSB7XG5cdFx0XHRcdFx0Y29uc29sZS5lcnJvcihlKTtcblx0XHRcdFx0fSk7XG5cdFx0XHRcdGJyZWFrO1xuXG5cdFx0XHRjYXNlICdpY2UnOlxuXHRcdFx0XHRpZiAobWVzc2FnZURhdGEuaWNlKSB7XG5cdFx0XHRcdFx0Y29uc29sZS5sb2coJ0FkZGluZyBpY2UgY2FuZGlkYXRlcy4uLiBPSyEnKTtcblx0XHRcdFx0XHRjb25zb2xlLmxvZyhtZXNzYWdlRGF0YSk7XG5cdFx0XHRcdFx0dmFyIGNhbmQ6IFJUQ0ljZUNhbmRpZGF0ZSA9IG5ldyBSVENJY2VDYW5kaWRhdGUobWVzc2FnZURhdGEuaWNlKTtcblx0XHRcdFx0XHRwZWVyLmFkZEljZUNhbmRpZGF0ZShjYW5kLCAoKSA9PiB7IH0sICgpID0+IHsgfSk7XG5cdFx0XHRcdH1cblx0XHRcdFx0YnJlYWs7XG5cdFx0fVxuXHR9XG5cblx0c2VuZE1lc3NhZ2UobWVzc2FnZTogc3RyaW5nKTogdm9pZCB7XG5cdFx0T2JqZWN0LmtleXModGhpcy5fY2hhbm5lbE1hcCkuZm9yRWFjaCgoa2V5KSA9PiB7XG5cdFx0XHRsZXQgY2hhbm5lbDogUlRDRGF0YUNoYW5uZWwgPSB0aGlzLl9jaGFubmVsTWFwW2tleV07XG5cdFx0XHRjaGFubmVsLnNlbmQobWVzc2FnZSk7XG5cdFx0fSk7XG5cdH1cblxuXHRwcml2YXRlIF9ldmVudE1hcDogT2JqZWN0ID0ge307XG5cblx0LyoqXG5cdCAqIEFsbG93cyBsaXN0ZW5pbmcgZm9yIGEgcGFydGljdWxhciBzZXQgb2YgbGlzdGVuZXJzIGZvciBhIGNlcnRhaW4gZXZlbnRcblx0ICovXG5cdG9uKGV2ZW50VHlwZTogc3RyaW5nLCBsaXN0ZW5lcjogRnVuY3Rpb24pIHtcblx0XHRpZiAoIXRoaXMuX2V2ZW50TWFwW2V2ZW50VHlwZV0pXG5cdFx0XHR0aGlzLl9ldmVudE1hcFtldmVudFR5cGVdID0gW107XG5cblx0XHR0aGlzLl9ldmVudE1hcFtldmVudFR5cGVdLnB1c2gobGlzdGVuZXIpO1xuXHR9XG5cblx0cHJpdmF0ZSB0cmlnZ2VyKGV2ZW50VHlwZTogc3RyaW5nLCBkYXRhOiBhbnkpIHtcblx0XHRjb25zb2xlLmxvZyhcIkRpc3BhdGNoaW5nIGV2ZW50OyBcIiArIGV2ZW50VHlwZSArIFwiIHRvIGFsbCBsaXN0ZW5lcnMuXCIpO1xuXHRcdHRoaXMuX2V2ZW50TWFwW2V2ZW50VHlwZV0uZm9yRWFjaChsaXN0ZW5lciA9PiB7XG5cdFx0XHRsaXN0ZW5lcihkYXRhKTtcblx0XHR9KTtcblx0fVxuXG5cdGdldCByb29tTmFtZSgpOiBzdHJpbmcge1xuXHRcdHJldHVybiB0aGlzLl9yb29tT3B0aW9ucy5yb29tTmFtZTtcblx0fVxuXG59XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=