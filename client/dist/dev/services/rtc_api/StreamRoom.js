var StreamPeer_1 = require('./StreamPeer');
var StreamRoom = (function () {
    function StreamRoom(localStreams, options, socket, sessionToken) {
        this._peerMap = {};
        this._channelMap = {};
        this._eventMap = {};
        this._localStreams = localStreams;
        this._roomOptions = options;
        this._socket = socket;
        this._sessionToken = sessionToken;
        var self = this;
        this._socket.on('msg', function (data) {
            console.log("Handling payload...");
            self.handleMessages(data);
        });
        this._socket.on('peer.connected', function (data) {
            self.makeOfferFor(data.id);
        });
        this._socket.on('peer.disconnected', function (data) {
            self.trigger('peer.removed', { id: data.id });
        });
    }
    StreamRoom.prototype.getPeerConnection = function (id) {
        if (this._peerMap[id]) {
            return this._peerMap[id];
        }
        var pc = new RTCPeerConnection(StreamRoom.ICE_CONFIG);
        var streamPeer = new StreamPeer_1.StreamPeer(pc, id);
        this._peerMap[id] = pc;
        var self = this;
        this._localStreams.forEach(function (stream) {
            pc.addStream(stream);
        });
        pc.onicecandidate = function (evnt) {
            console.log("ICE candidate recieved... broadcasting request");
            console.log(self._sessionToken);
            self._socket.emit('msg', { by: self._sessionToken, to: id, ice: evnt.candidate, type: 'ice' });
        };
        pc.onaddstream = function (event) {
            console.log("Got new stream.. inform UI?");
            self.trigger('newstream', event);
        };
        pc.onremovestream = function (event) {
            console.log("Stream lost");
        };
        var options = {
            ordered: false
        };
        var _channel = pc.createDataChannel("data", options);
        _channel.onopen = function () {
            console.log("Attempted to send data down the pipe.");
        };
        this._channelMap[id] = _channel;
        pc.ondatachannel = function (event) {
            console.log(event);
            console.log("Channel was created");
            event.channel.onmessage = function (payload) {
                self.trigger('data', payload.data);
            };
        };
        return pc;
    };
    StreamRoom.prototype.makeOfferFor = function (id) {
        var _this = this;
        var peer = this.getPeerConnection(id);
        peer.createOffer(function (description) {
            peer.setLocalDescription(description);
            console.log("Creating offer for Peer... ID: " + id);
            _this._socket.emit('msg', { by: _this._sessionToken, to: id, sdp: description, type: 'sdp-offer' });
        });
    };
    StreamRoom.prototype.handleMessages = function (messageData) {
        var peer = this.getPeerConnection(messageData.by);
        var self = this;
        switch (messageData.type) {
            case 'sdp-offer':
                peer.setRemoteDescription(new RTCSessionDescription(messageData.sdp), function () {
                    console.log('Setting remote description by offer');
                    peer.createAnswer(function (sdp) {
                        peer.setLocalDescription(sdp);
                        self._socket.emit('msg', { by: self._sessionToken, to: messageData.by, sdp: sdp, type: 'sdp-answer' });
                    });
                });
                break;
            case 'sdp-answer':
                peer.setRemoteDescription(new RTCSessionDescription(messageData.sdp), function () {
                    console.log('Setting remote description by answer');
                }, function (e) {
                    console.error(e);
                });
                break;
            case 'ice':
                if (messageData.ice) {
                    console.log('Adding ice candidates... OK!');
                    console.log(messageData);
                    var cand = new RTCIceCandidate(messageData.ice);
                    peer.addIceCandidate(cand, function () { }, function () { });
                }
                break;
        }
    };
    StreamRoom.prototype.sendMessage = function (message) {
        var _this = this;
        Object.keys(this._channelMap).forEach(function (key) {
            var channel = _this._channelMap[key];
            channel.send(message);
        });
    };
    StreamRoom.prototype.on = function (eventType, listener) {
        if (!this._eventMap[eventType])
            this._eventMap[eventType] = [];
        this._eventMap[eventType].push(listener);
    };
    StreamRoom.prototype.trigger = function (eventType, data) {
        console.log("Dispatching event; " + eventType + " to all listeners.");
        this._eventMap[eventType].forEach(function (listener) {
            listener(data);
        });
    };
    Object.defineProperty(StreamRoom.prototype, "roomName", {
        get: function () {
            return this._roomOptions.roomName;
        },
        enumerable: true,
        configurable: true
    });
    StreamRoom.ICE_CONFIG = {
        'iceServers': [{
                'url': 'stun:stun.l.google.com:19302'
            }]
    };
    return StreamRoom;
})();
exports.StreamRoom = StreamRoom;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZpY2VzL3J0Y19hcGkvU3RyZWFtUm9vbS50cyJdLCJuYW1lcyI6WyJTdHJlYW1Sb29tIiwiU3RyZWFtUm9vbS5jb25zdHJ1Y3RvciIsIlN0cmVhbVJvb20uZ2V0UGVlckNvbm5lY3Rpb24iLCJTdHJlYW1Sb29tLm1ha2VPZmZlckZvciIsIlN0cmVhbVJvb20uaGFuZGxlTWVzc2FnZXMiLCJTdHJlYW1Sb29tLnNlbmRNZXNzYWdlIiwiU3RyZWFtUm9vbS5vbiIsIlN0cmVhbVJvb20udHJpZ2dlciIsIlN0cmVhbVJvb20ucm9vbU5hbWUiXSwibWFwcGluZ3MiOiJBQUNBLDJCQUF5QixjQUV6QixDQUFDLENBRnNDO0FBRXZDO0lBZ0JDQSxvQkFBWUEsWUFBZ0NBLEVBQUVBLE9BQW9CQSxFQUFFQSxNQUFjQSxFQUFFQSxZQUFvQkE7UUFIaEdDLGFBQVFBLEdBQVdBLEVBQUVBLENBQUNBO1FBQ3RCQSxnQkFBV0EsR0FBV0EsRUFBRUEsQ0FBQ0E7UUEySXpCQSxjQUFTQSxHQUFXQSxFQUFFQSxDQUFDQTtRQXhJOUJBLElBQUlBLENBQUNBLGFBQWFBLEdBQUdBLFlBQVlBLENBQUNBO1FBQ2xDQSxJQUFJQSxDQUFDQSxZQUFZQSxHQUFHQSxPQUFPQSxDQUFDQTtRQUM1QkEsSUFBSUEsQ0FBQ0EsT0FBT0EsR0FBR0EsTUFBTUEsQ0FBQ0E7UUFDdEJBLElBQUlBLENBQUNBLGFBQWFBLEdBQUdBLFlBQVlBLENBQUNBO1FBRWxDQSxJQUFJQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUdoQkEsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsS0FBS0EsRUFBRUEsVUFBQ0EsSUFBSUE7WUFDM0JBLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLHFCQUFxQkEsQ0FBQ0EsQ0FBQ0E7WUFDbkNBLElBQUlBLENBQUNBLGNBQWNBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1FBQzNCQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUVIQSxJQUFJQSxDQUFDQSxPQUFP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T0EsR0FBZkEsVUFBZ0JBLFNBQWlCQSxFQUFFQSxJQUFTQTtRQUMzQ08sT0FBT0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EscUJBQXFCQSxHQUFHQSxTQUFTQSxHQUFHQSxvQkFBb0JBLENBQUNBLENBQUNBO1FBQ3RFQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQSxPQUFPQSxDQUFDQSxVQUFBQSxRQUFRQTtZQUN6Q0EsUUFBUUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDaEJBLENBQUNBLENBQUNBLENBQUNBO0lBQ0pBLENBQUNBO0lBRURQLHNCQUFJQSxnQ0FBUUE7YUFBWkE7WUFDQ1EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsUUFBUUEsQ0FBQ0E7UUFDbkNBLENBQUNBOzs7T0FBQVI7SUE1S2NBLHFCQUFVQSxHQUFXQTtRQUNuQ0EsWUFBWUEsRUFBRUEsQ0FBQ0E7Z0JBQ2RBLEtBQUtBLEVBQUVBLDhCQUE4QkE7YUFDckNBLENBQUNBO0tBQ0ZBLENBQUFBO0lBMEtGQSxpQkFBQ0E7QUFBREEsQ0FoTEEsQUFnTENBLElBQUE7QUFoTFksa0JBQVUsYUFnTHRCLENBQUEiLCJmaWxlIjoic2VydmljZXMvcnRjX2FwaS9TdHJlYW1Sb29tLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtSb29tT3B0aW9uc30gZnJvbSAnLi9Sb29tT3B0aW9ucydcbmltcG9ydCB7U3RyZWFtUGVlcn0gZnJvbSAnLi9TdHJlYW1QZWVyJ1xuXG5leHBvcnQgY2xhc3MgU3RyZWFtUm9vbSB7XG5cdC8vIFRPRE86IFRoaXMgc2hvdWxkIG5vdCBiZSBoYXJkLWNvZGVkIGlkZWFsbHkuLi4gYnV0IGl0IHdvbid0IGh1cnQgZm9yIG5vd1xuXHRwcml2YXRlIHN0YXRpYyBJQ0VfQ09ORklHOiBPYmplY3QgPSB7XG5cdFx0J2ljZVNlcnZlcnMnOiBbe1xuXHRcdFx0J3VybCc6ICdzdHVuOnN0dW4ubC5nb29nbGUuY29tOjE5MzAyJ1xuXHRcdH1dXG5cdH1cblxuXHRwcml2YXRlIF9yb29tT3B0aW9uczogUm9vbU9wdGlvbnM7XG5cdHByaXZhdGUgX2xvY2FsU3RyZWFtczogQXJyYXk8TWVkaWFTdHJlYW0+O1xuXHRwcml2YXRlIF9zb2NrZXQ6IFNvY2tldDtcblx0cHJpdmF0ZSBfc2Vzc2lvblRva2VuOiBzdHJpbmc7XG5cblx0cHJpdmF0ZSBfcGVlck1hcDogT2JqZWN0ID0ge307XG5cdHByaXZhdGUgX2NoYW5uZWxNYXA6IE9iamVjdCA9IHt9O1xuXG5cdGNvbnN0cnVjdG9yKGxvY2FsU3RyZWFtczogQXJyYXk8TWVkaWFTdHJlYW0+LCBvcHRpb25zOiBSb29tT3B0aW9ucywgc29ja2V0OiBTb2NrZXQsIHNlc3Npb25Ub2tlbjogc3RyaW5nKSB7XG5cdFx0dGhpcy5fbG9jYWxTdHJlYW1zID0gbG9jYWxTdHJlYW1zO1xuXHRcdHRoaXMuX3Jvb21PcHRpb25zID0gb3B0aW9ucztcblx0XHR0aGlzLl9zb2NrZXQgPSBzb2NrZXQ7XG5cdFx0dGhpcy5fc2Vzc2lvblRva2VuID0gc2Vzc2lvblRva2VuO1xuXG5cdFx0dmFyIHNlbGYgPSB0aGlzO1xuXHRcdFxuXHRcdC8vIFJlZ2lzdGVyIGhhbmRsZXJzIGFzIG5lZWRlZFxuXHRcdHRoaXMuX3NvY2tldC5vbignbXNnJywgKGRhdGEpID0+IHtcblx0XHRcdGNvbnNvbGUubG9nKFwiSGFuZGxpbmcgcGF5bG9hZC4uLlwiKTtcblx0XHRcdHNlbGYuaGFuZGxlTWVzc2FnZXMoZGF0YSk7XG5cdFx0fSk7XG5cblx0XHR0aGlzLl9zb2NrZXQub24oJ3BlZXIuY29ubmVjdGVkJywgKGRhdGEpID0+IHtcblx0XHRcdHNlbGYubWFrZU9mZmVyRm9yKGRhdGEuaWQpO1xuXHRcdH0pO1xuXG5cdFx0dGhpcy5fc29ja2V0Lm9uKCdwZWVyLmRpc2Nvbm5lY3RlZCcsIChkYXRhKSA9PiB7XG5cdFx0XHRzZWxmLnRyaWdnZXIoJ3BlZXIucmVtb3ZlZCcsIHsgaWQ6IGRhdGEuaWQgfSk7XG5cdFx0fSlcblx0fVxuXG5cdHByaXZhdGUgZ2V0UGVlckNvbm5lY3Rpb24oaWQ6IHN0cmluZyk6IFJUQ1BlZXJDb25uZWN0aW9uIHtcblx0XHRpZiAodGhpcy5fcGVlck1hcFtpZF0pIHtcblx0XHRcdHJldHVybiB0aGlzLl9wZWVyTWFwW2lkXTtcblx0XHR9XG5cblx0XHR2YXIgcGM6IFJUQ1BlZXJDb25uZWN0aW9uID0gbmV3IFJUQ1BlZXJDb25uZWN0aW9uKFN0cmVhbVJvb20uSUNFX0NPTkZJRyk7XG5cdFx0XG5cdFx0Ly8gVE9ETzogSW1wbGVtZW50IGEgc3RhY2sgdGhhdCB1c2VzIHRoZSB7U3RyZWFtUGVlcn1cblx0XHQvLyBSaWdodCBub3csIHdlIHJlbHkgb24gdGhlIGJhcmUgbWV0YWwgaW1wbGVtZW50YXRpb24uXG5cdFx0XG5cdFx0dmFyIHN0cmVhbVBlZXIgOiBTdHJlYW1QZWVyID0gbmV3IFN0cmVhbVBlZXIocGMsIGlkKTtcblx0XHRcblxuXHRcdHRoaXMuX3BlZXJNYXBbaWRdID0gcGM7XG5cblx0XHR2YXIgc2VsZiA9IHRoaXM7XG5cdFx0XG5cdFx0Ly8gQWRkIGFsbCBzdHJlYW1zXG5cdFx0dGhpcy5fbG9jYWxTdHJlYW1zLmZvckVhY2goKHN0cmVhbSkgPT4ge1xuXHRcdFx0cGMuYWRkU3RyZWFtKHN0cmVhbSk7XG5cdFx0fSlcblxuXHRcdHBjLm9uaWNlY2FuZGlkYXRlID0gZnVuY3Rpb24oZXZudCkge1xuXHRcdFx0Y29uc29sZS5sb2coXCJJQ0UgY2FuZGlkYXRlIHJlY2lldmVkLi4uIGJyb2FkY2FzdGluZyByZXF1ZXN0XCIpO1xuXHRcdFx0Y29uc29sZS5sb2coc2VsZi5fc2Vzc2lvblRva2VuKTtcblx0XHRcdHNlbGYuX3NvY2tldC5lbWl0KCdtc2cnLCB7IGJ5OiBzZWxmLl9zZXNzaW9uVG9rZW4sIHRvOiBpZCwgaWNlOiBldm50LmNhbmRpZGF0ZSwgdHlwZTogJ2ljZScgfSk7XG5cdFx0fTtcblx0XHRcblx0XHRwYy5vbmFkZHN0cmVhbSA9IGZ1bmN0aW9uKGV2ZW50KSB7XG5cdFx0XHRjb25zb2xlLmxvZyhcIkdvdCBuZXcgc3RyZWFtLi4gaW5mb3JtIFVJP1wiKTtcblx0XHRcdHNlbGYudHJpZ2dlcignbmV3c3RyZWFtJywgZXZlbnQpO1xuXHRcdH07XG5cblx0XHRwYy5vbnJlbW92ZXN0cmVhbSA9IGZ1bmN0aW9uKGV2ZW50KSB7XG5cdFx0XHRjb25zb2xlLmxvZyhcIlN0cmVhbSBsb3N0XCIpO1xuXHRcdH1cblx0XG5cdFx0XG5cdFx0Ly8gQ2FsbGJhY2tzIGZvciB0ZXh0IHN0cmVhbXNcblx0XHR2YXIgb3B0aW9ucyA9IHtcblx0XHRcdG9yZGVyZWQ6IGZhbHNlXG5cdFx0fVxuXG5cdFx0dmFyIF9jaGFubmVsOiBSVENEYXRhQ2hhbm5lbCA9IHBjLmNyZWF0ZURhdGFDaGFubmVsKFwiZGF0YVwiLCBvcHRpb25zKTtcblxuXHRcdF9jaGFubmVsLm9ub3BlbiA9ICgpID0+IHtcblx0XHRcdGNvbnNvbGUubG9nKFwiQXR0ZW1wdGVkIHRvIHNlbmQgZGF0YSBkb3duIHRoZSBwaXBlLlwiKTtcblx0XHR9O1xuXHRcdFxuXHRcdC8vIE1hcHMgdG8gdGhlIGNoYW5uZWxcblx0XHR0aGlzLl9jaGFubmVsTWFwW2lkXSA9IF9jaGFubmVsO1xuXG5cdFx0cGMub25kYXRhY2hhbm5lbCA9IChldmVudDogYW55KSA9PiB7XG5cdFx0XHRjb25zb2xlLmxvZyhldmVudCk7XG5cdFx0XHRjb25zb2xlLmxvZyhcIkNoYW5uZWwgd2FzIGNyZWF0ZWRcIik7XG5cdFx0XHRldmVudC5jaGFubmVsLm9ubWVzc2FnZSA9IChwYXlsb2FkKSA9PiB7XG5cdFx0XHRcdHNlbGYudHJpZ2dlcignZGF0YScsIHBheWxvYWQuZGF0YSk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHBjO1xuXHR9XG5cblx0cHJpdmF0ZSBtYWtlT2ZmZXJGb3IoaWQ6IHN0cmluZykge1xuXHRcdHZhciBwZWVyOiBSVENQZWVyQ29ubmVjdGlvbiA9IHRoaXMuZ2V0UGVlckNvbm5lY3Rpb24oaWQpO1xuXG5cdFx0cGVlci5jcmVhdGVPZmZlcigoZGVzY3JpcHRpb246IFJUQ1Nlc3Npb25EZXNjcmlwdGlvbikgPT4ge1xuXHRcdFx0cGVlci5zZXRMb2NhbERlc2NyaXB0aW9uKGRlc2NyaXB0aW9uKTtcblx0XHRcdGNvbnNvbGUubG9nKFwiQ3JlYXRpbmcgb2ZmZXIgZm9yIFBlZXIuLi4gSUQ6IFwiICsgaWQpO1xuXHRcdFx0dGhpcy5fc29ja2V0LmVtaXQoJ21zZycsIHsgYnk6IHRoaXMuX3Nlc3Npb25Ub2tlbiwgdG86IGlkLCBzZHA6IGRlc2NyaXB0aW9uLCB0eXBlOiAnc2RwLW9mZmVyJyB9KTtcblx0XHR9KVxuXHR9XG5cblx0cHJpdmF0ZSBoYW5kbGVNZXNzYWdlcyhtZXNzYWdlRGF0YTogYW55KSB7XG5cdFx0dmFyIHBlZXI6IFJUQ1BlZXJDb25uZWN0aW9uID0gdGhpcy5nZXRQZWVyQ29ubmVjdGlvbihtZXNzYWdlRGF0YS5ieSk7XG5cdFx0dmFyIHNlbGYgPSB0aGlzO1xuXG5cdFx0c3dpdGNoIChtZXNzYWdlRGF0YS50eXBlKSB7XG5cdFx0XHRjYXNlICdzZHAtb2ZmZXInOlxuXHRcdFx0XHRwZWVyLnNldFJlbW90ZURlc2NyaXB0aW9uKG5ldyBSVENTZXNzaW9uRGVzY3JpcHRpb24obWVzc2FnZURhdGEuc2RwKSwgZnVuY3Rpb24oKSB7XG5cdFx0XHRcdFx0Y29uc29sZS5sb2coJ1NldHRpbmcgcmVtb3RlIGRlc2NyaXB0aW9uIGJ5IG9mZmVyJyk7XG5cdFx0XHRcdFx0cGVlci5jcmVhdGVBbnN3ZXIoZnVuY3Rpb24oc2RwKSB7XG5cdFx0XHRcdFx0XHRwZWVyLnNldExvY2FsRGVzY3JpcHRpb24oc2RwKTtcblx0XHRcdFx0XHRcdHNlbGYuX3NvY2tldC5lbWl0KCdtc2cnLCB7IGJ5OiBzZWxmLl9zZXNzaW9uVG9rZW4sIHRvOiBtZXNzYWdlRGF0YS5ieSwgc2RwOiBzZHAsIHR5cGU6ICdzZHAtYW5zd2VyJyB9KTtcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fSk7XG5cdFx0XHRcdGJyZWFrO1xuXG5cdFx0XHRjYXNlICdzZHAtYW5zd2VyJzpcblx0XHRcdFx0cGVlci5zZXRSZW1vdGVEZXNjcmlwdGlvbihuZXcgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKG1lc3NhZ2VEYXRhLnNkcCksIGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRcdGNvbnNvbGUubG9nKCdTZXR0aW5nIHJlbW90ZSBkZXNjcmlwdGlvbiBieSBhbnN3ZXInKTtcblx0XHRcdFx0fSwgZnVuY3Rpb24oZSkge1xuXHRcdFx0XHRcdGNvbnNvbGUuZXJyb3IoZSk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRicmVhaztcblxuXHRcdFx0Y2FzZSAnaWNlJzpcblx0XHRcdFx0aWYgKG1lc3NhZ2VEYXRhLmljZSkge1xuXHRcdFx0XHRcdGNvbnNvbGUubG9nKCdBZGRpbmcgaWNlIGNhbmRpZGF0ZXMuLi4gT0shJyk7XG5cdFx0XHRcdFx0Y29uc29sZS5sb2cobWVzc2FnZURhdGEpO1xuXHRcdFx0XHRcdHZhciBjYW5kOiBSVENJY2VDYW5kaWRhdGUgPSBuZXcgUlRDSWNlQ2FuZGlkYXRlKG1lc3NhZ2VEYXRhLmljZSk7XG5cdFx0XHRcdFx0cGVlci5hZGRJY2VDYW5kaWRhdGUoY2FuZCwgKCkgPT4geyB9LCAoKSA9PiB7IH0pO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGJyZWFrO1xuXHRcdH1cblx0fVxuXG5cdHNlbmRNZXNzYWdlKG1lc3NhZ2U6IHN0cmluZyk6IHZvaWQge1xuXHRcdE9iamVjdC5rZXlzKHRoaXMuX2NoYW5uZWxNYXApLmZvckVhY2goKGtleSkgPT4ge1xuXHRcdFx0bGV0IGNoYW5uZWw6IFJUQ0RhdGFDaGFubmVsID0gdGhpcy5fY2hhbm5lbE1hcFtrZXldO1xuXHRcdFx0Y2hhbm5lbC5zZW5kKG1lc3NhZ2UpO1xuXHRcdH0pO1xuXHR9XG5cblx0cHJpdmF0ZSBfZXZlbnRNYXA6IE9iamVjdCA9IHt9O1xuXG5cdC8qKlxuXHQgKiBBbGxvd3MgbGlzdGVuaW5nIGZvciBhIHBhcnRpY3VsYXIgc2V0IG9mIGxpc3RlbmVycyBmb3IgYSBjZXJ0YWluIGV2ZW50XG5cdCAqL1xuXHRvbihldmVudFR5cGU6IHN0cmluZywgbGlzdGVuZXI6IEZ1bmN0aW9uKSB7XG5cdFx0aWYgKCF0aGlzLl9ldmVudE1hcFtldmVudFR5cGVdKVxuXHRcdFx0dGhpcy5fZXZlbnRNYXBbZXZlbnRUeXBlXSA9IFtdO1xuXG5cdFx0dGhpcy5fZXZlbnRNYXBbZXZlbnRUeXBlXS5wdXNoKGxpc3RlbmVyKTtcblx0fVxuXG5cdHByaXZhdGUgdHJpZ2dlcihldmVudFR5cGU6IHN0cmluZywgZGF0YTogYW55KSB7XG5cdFx0Y29uc29sZS5sb2coXCJEaXNwYXRjaGluZyBldmVudDsgXCIgKyBldmVudFR5cGUgKyBcIiB0byBhbGwgbGlzdGVuZXJzLlwiKTtcblx0XHR0aGlzLl9ldmVudE1hcFtldmVudFR5cGVdLmZvckVhY2gobGlzdGVuZXIgPT4ge1xuXHRcdFx0bGlzdGVuZXIoZGF0YSk7XG5cdFx0fSk7XG5cdH1cblxuXHRnZXQgcm9vbU5hbWUoKTogc3RyaW5nIHtcblx0XHRyZXR1cm4gdGhpcy5fcm9vbU9wdGlvbnMucm9vbU5hbWU7XG5cdH1cblxufSJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==